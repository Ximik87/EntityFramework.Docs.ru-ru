---
title: EF6 Database First.
author: divega
ms.date: 10/23/2016
ms.assetid: cc6ffdb3-388d-4e79-a201-01ec2577c949
ms.openlocfilehash: c81025fe7c3ad6398f003f7be2a3f9f072eec327
ms.sourcegitcommit: 269c8a1a457a9ad27b4026c22c4b1a76991fb360
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2018
ms.locfileid: "46284087"
---
# <a name="database-first"></a>База данных как основа
Следующие видео и пошаговые руководства познакомят вас с разработкой, использующей Entity Framework, основываясь на базе данных. Такой подход дает возможность реконструировать модель из существующей базы данных. Модель хранится в EDMX-файле (расширение .emdx) и её можно просмотреть и изменить в конструкторе Entity Framework. Классы, с которыми вы взаимодействуете в приложении, автоматически создаются из файла EDMX.

## <a name="watch-the-video"></a>Просмотрите видео
Это видео предоставляет общие сведения о разработке, использующей Entity Framework, основываясь на базе данных. 

**Представляет**: [Роуэн Миллер (Rowan Miller)](http://romiller.com/)

**Видео**: [WMV](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-winvideo-databasefirst.wmv) | [MP4](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-mp4video-databasefirst.m4v) | [WMV (ZIP)](https://download.microsoft.com/download/8/F/0/8F0B5F63-4939-4DC8-A726-FF139B37F8D8/HDI-ITPro-MSDN-winvideo-databasefirst.zip)

## <a name="pre-requisites"></a>Предварительные требования

Для выполнения этого пошагового руководства необходимо иметь по крайней мере Visual Studio 2010 или Visual Studio 2012.

Если вы используете Visual Studio 2010, также необходимо будет установить [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c).

 

## <a name="1-create-an-existing-database"></a>1. Создание базы данных

Обычно ориентируются на существующую базу данных, и в этом случае она уже будет создана, но для этого пошагового руководства нам необходимо создать базу данных для доступа.

Сервер базы данных, который устанавливается вместе с Visual Studio отличается в зависимости от версии Visual Studio, которую вы установили:

-   Если вы используете Visual Studio 2010, вы создадите базу данных SQL Express.
-   Если вы используете Visual Studio 2012, вы создадите базу данных [LocalDB](https://msdn.microsoft.com/library/hh510202(v=sql.110).aspx).


Перейдем дальше и создадим базу данных.

-   Откройте Visual Studio
-   **Вид —&gt; Обозреватель серверов**
-   Щелкните правой кнопкой мыши на **Подключения к данным -&gt; Добавить соединение...**
-   Если вы не подключились к базе данных с помощью обозревателя сервера прежде, вам потребуется выбрать в качестве источника данных Microsoft SQL Server

    ![Выберите источник данных](~/ef6/media/selectdatasource.png)

-   Подключитесь к LocalDB или SQL Express, в зависимости от того, какую из них вы установили и введите имя базы данных **DatabaseFirst.Blogging**

    ![Подключение SQL Express DF](~/ef6/media/sqlexpressconnectiondf.png)

    ![Подключение LocalDB DF](~/ef6/media/localdbconnectiondf.png)

-   Выберите **ОК** и вам будет задан вопрос, хотите ли вы создать новую базу данных. Выберите **Да**

    ![Создание диалогового окна базы данных](~/ef6/media/createdatabasedialog.png)

-   Новая база данных появится в обозревателе сервера. Щелкните на ней правой кнопкой мыши и выберите **Новый запрос**
-   Скопируйте следующий SQL в новый запрос, затем щелкните правой кнопкой мыши на запросе и выберите **Выполнить**

``` SQL
CREATE TABLE [dbo].[Blogs] (
    [BlogId] INT IDENTITY (1, 1) NOT NULL,
    [Name] NVARCHAR (200) NULL,
    [Url]  NVARCHAR (200) NULL,
    CONSTRAINT [PK_dbo.Blogs] PRIMARY KEY CLUSTERED ([BlogId] ASC)
);

CREATE TABLE [dbo].[Posts] (
    [PostId] INT IDENTITY (1, 1) NOT NULL,
    [Title] NVARCHAR (200) NULL,
    [Content] NTEXT NULL,
    [BlogId] INT NOT NULL,
    CONSTRAINT [PK_dbo.Posts] PRIMARY KEY CLUSTERED ([PostId] ASC),
    CONSTRAINT [FK_dbo.Posts_dbo.Blogs_BlogId] FOREIGN KEY ([BlogId]) REFERENCES [dbo].[Blogs] ([BlogId]) ON DELETE CASCADE
);
```

## <a name="2-create-the-application"></a>2. Создайте приложение

Для простоты мы создадим простое консольное приложение, использующее подход, основывающийся на базе данных, для выполнения доступа к данным:

-   Откройте Visual Studio
-   **Файл —&gt; Новый —&gt; Проект...**
-   Выберите **Windows** в меню слева и **Консольное приложение**
-   Введите **DatabaseFirstSample** в поле Имя
-   Нажмите кнопку **ОК**

 

## <a name="3-reverse-engineer-model"></a>3. Реконструируйте модель

Для создания нашей модели мы собираемся использовать Entity Framework Designer, который входит в состав Visual Studio.

-   **Проект -&gt; Добавить новый элемент...**
-   Выберите **Данные** в меню слева и затем **Модель EDM ADO.NET**
-   Введите имя **BloggingModel** и нажмите кнопку **ОК**
-   Это откроет **Мастер моделей EDM**
-   Выберите **Создать из базы данных** и нажмите кнопку **Далее**

    ![Мастер, шаг 1](~/ef6/media/wizardstep1.png)

-   Выберите соединение с базой данных, созданной в первом разделе, введите **BloggingContext** как имя строки подключения и нажмите кнопку **Далее**

    ![Шаг мастера 2](~/ef6/media/wizardstep2.png)

-   Установите флажок рядом с «Таблицы», чтобы импортировать все таблицы и нажмите кнопку «Готово»

    ![Мастер шаг 3](~/ef6/media/wizardstep3.png)


После завершения процесса реконструирования новая модель будет добавлена в проект и откроется для просмотра в конструкторе Entity Framework. Файл App.config со сведениями о подключении к базе данных также будет добавлен в проект.

![Начальная модель](~/ef6/media/modelinitial.png)

### <a name="additional-steps-in-visual-studio-2010"></a>Дополнительные действия в Visual Studio 2010

Если вы работаете в Visual Studio 2010, существуют некоторые дополнительные действия, которые необходимо выполнить для обновления до последней версии платформы Entity Framework. Обновление важно, так как оно предоставляет вам доступ к улучшенному API, который гораздо проще в использовании, а также последние исправления ошибок.

Во-первых, нам нужно получить последнюю версию Entity Framework из NuGet.

-   **Проект —&gt; Управление пакетами NuGet... ** 
     *При отсутствии пункта **Управление пакетами NuGet... ** следует установить [последнюю версию NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c)*
-   Выберите вкладку **Online**
-   Выберите пакет **EntityFramework**
-   Нажмите кнопку **Установить**

Далее нам нужно переключить нашу модель, чтобы сгенерировать код, который использует API DbContext, появившийся в более поздних версиях Entity Framework.

-   Щелкните правой кнопкой мыши на пустом месте модели в конструкторе EF и выберите **Добавить элемент формирования кода...**
-   Выберите **Шаблоны в Интернете** из меню слева и выполните поиск **DbContext**
-   Выберите EF **Генератор 5.x DbContext для C\#**, введите имя **BloggingModel** и нажмите кнопку **Добавить**

    ![Шаблон DbContext](~/ef6/media/dbcontexttemplate.png)


## <a name="4-reading--writing-data"></a>4. Чтение и запись данных

Теперь, когда у нас есть модель, настала пора использовать ее для доступа к каким-нибудь данным. Классы, которые мы будем использовать для доступа к данным, автоматически создаются в зависимости от EDMX-файла.

*Этот снимок экрана из Visual Studio 2012. Если вы используете Visual Studio 2010, файлы BloggingModel.tt и BloggingModel.Context.tt будут лежать непосредственно в проекте, а не вложены в узел EDMX-файла.*

![Созданные классы DF](~/ef6/media/generatedclassesdf.png)


Реализуйте метод Main в файле Program.cs так, как показано ниже. Этот код создает новый экземпляр нашего контекста, а затем использует его для вставки нового блога. Затем он использует запрос LINQ для извлечения из базы данных всех блогов, упорядоченных в алфавитном порядке по названию.

``` csharp
class Program
{
    static void Main(string[] args)
    {
        using (var db = new BloggingContext())
        {
            // Create and save a new Blog
            Console.Write("Enter a name for a new Blog: ");
            var name = Console.ReadLine();

            var blog = new Blog { Name = name };
            db.Blogs.Add(blog);
            db.SaveChanges();

            // Display all Blogs from the database
            var query = from b in db.Blogs
                        orderby b.Name
                        select b;

            Console.WriteLine("All blogs in the database:");
            foreach (var item in query)
            {
                Console.WriteLine(item.Name);
            }

            Console.WriteLine("Press any key to exit...");
            Console.ReadKey();
        }
    }
}
```

Теперь можно запустить приложение и протестировать его.

```
Enter a name for a new Blog: ADO.NET Blog
All blogs in the database:
ADO.NET Blog
Press any key to exit...
```
 

## <a name="5-dealing-with-database-changes"></a>5. Изменения базы данных

Теперь пора внести некоторые изменения в схему нашей базы данных. Когда мы внесём эти изменения, необходимо также обновить нашу модель, чтобы отразить эти изменения.

Первый шаг - это внесение некоторых изменений в схему базы данных. Мы собираемся добавить таблицу пользователей в схему.

-   Щелкните правой кнопкой мыши на базе данных **DatabaseFirst.Blogging** в обозревателе сервера и выберите **Новый запрос**
-   Скопируйте следующий SQL в новый запрос, затем щелкните правой кнопкой мыши на запросе и выберите **Execute**

``` SQL
CREATE TABLE [dbo].[Users]
(
    [Username] NVARCHAR(50) NOT NULL PRIMARY KEY,  
    [DisplayName] NVARCHAR(MAX) NULL
)
```

Теперь, когда схема обновлена, пришло время для обновления модели с помощью этих изменений.

-   Щелкните правой кнопкой мыши пустое место модели в конструкторе EF и выберите «Обновить модель из базы данных...», это приведет к запуску мастера обновления
-   На вкладке "Добавить" мастера обновления установите флажок рядом с таблицами. Это означает, что мы хотим добавить новые таблицы из схемы.
    *На вкладке обновления отображаются все имеющиеся таблицы в модели, которые будут проверены на изменения во время обновления. На вкладке Delete отображаются все таблицы, которые были удалены из схемы, а также будут удалены из модели как часть обновления. Сведения на этих двух вкладках формируются автоматически и предоставляются только в ознакомительных целях, нельзя изменить какие-либо параметры.*

    ![Обновление мастера](~/ef6/media/refreshwizard.png)

-   Щелкните "Готово" в мастере обновления


Теперь модель обновлена. Добавлена новая сущность Пользователь, которая сопоставляется с таблицей пользователей, которую мы добавили в базу данных.

![Модель обновлена](~/ef6/media/modelupdated.png)

## <a name="summary"></a>Сводка

В этом пошаговом руководстве мы рассмотрели разработку Database First, которая позволяет создать модель в конструкторе EF, основываясь на существующей базе данных. Мы использовали эту модель для чтения и записи некоторых данных из базы данных. Наконец, мы обновили модель для отражения изменений, внесенных в схему базы данных.
