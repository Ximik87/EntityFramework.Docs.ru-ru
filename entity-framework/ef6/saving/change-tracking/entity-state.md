---
title: Работа с состояния сущностей - EF6
author: divega
ms.date: 10/23/2016
ms.assetid: acb27f46-3f3a-4179-874a-d6bea5d7120c
ms.openlocfilehash: ef0e8d5a5a9d66adab7046088c49d8cd472edc8a
ms.sourcegitcommit: e5f9ca4aa41e64141fa63a1e5fcf4d4775d67d24
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2018
ms.locfileid: "52899656"
---
# <a name="working-with-entity-states"></a>Работа с состояния сущностей
В этом разделе будут рассмотрены способы добавления и присоединить сущности к контексту и как платформа Entity Framework преобразует их во время SaveChanges.
Платформа Entity Framework берет на себя отслеживания состояния сущностей, пока они подключены к контексту, но в отключенном или N-уровневых сценариях можно позволить платформе EF, какое состояние сущности должны находиться в.
Методы, представленные в этом разделе, также применимы к моделям, созданным с помощью Code First и конструктора EF.  

## <a name="entity-states-and-savechanges"></a>Состояния сущностей и SaveChanges

Сущность может быть в одном из пяти состояний, как определено в перечислении EntityState. Возможны следующие состояния:  

- Добавлена: сущность отслеживается контекстом, но еще не существует в базе данных  
- Без изменений: отслеживается контекстом и сущности в базе данных и значения его свойств, не отличаются от значений в базе данных  
- Изменен: сущность отслеживается контекстом и существует в базе данных, а также были изменены некоторые или все значения его свойств  
- Удаленные: сущности отслеживается контекстом в базе данных, но теперь помечено для удаления из базы данных в следующий раз в вызове метода SaveChanges  
- Отсоединенные: сущность не отслеживается контекстом  

SaveChanges выполняет различные действия для сущностей в различных состояниях.  

- Без изменений сущности, не менялись с SaveChanges. Обновления не отправляются в базу данных для сущностей в неизмененном состоянии.  
- Добавлены сущности вставляются в базу данных и затем становятся без изменений при возвращает SaveChanges.  
- Измененных сущностей обновляются в базе данных и затем становятся не изменяются при возвращает SaveChanges.  
- Удаленные сущности будут удалены из базы данных и затем отсоединяются от контекста.  

Ниже приведены примеры способов, в котором можно изменить состояние объекта или графа объекта.  

## <a name="adding-a-new-entity-to-the-context"></a>Добавление новой сущности в контекст  

Можно добавить новую сущность в контекст путем вызова метода Add для DbSet.
Этот запрос помещает сущность в добавленном состоянии, это означает, что она будет вставлена в базу данных во время следующего вызова метода SaveChanges.
Пример:  

``` csharp
using (var context = new BloggingContext())
{
    var blog = new Blog { Name = "ADO.NET Blog" };
    context.Blogs.Add(blog);
    context.SaveChanges();
}
```  

Чтобы изменить его состояние на добавленное является другим способом добавления новой сущности в контекст. Пример:  

``` csharp
using (var context = new BloggingContext())
{
    var blog = new Blog { Name = "ADO.NET Blog" };
    context.Entry(blog).State = EntityState.Added;
    context.SaveChanges();
}
```  

Наконец можно добавить новую сущность в контекст путем ее прикрепления к до другой сущности, которая уже отслеживается.
Это может быть путем добавления новой сущности к другой сущности свойство навигации по коллекции, или установив свойства навигации ссылки другой сущности, чтобы он указывал на новую сущность. Пример:  

``` csharp
using (var context = new BloggingContext())
{
    // Add a new User by setting a reference from a tracked Blog
    var blog = context.Blogs.Find(1);
    blog.Owner = new User { UserName = "johndoe1987" };

    // Add a new Post by adding to the collection of a tracked Blog
    blog.Posts.Add(new Post { Name = "How to Add Entities" });

    context.SaveChanges();
}
```  

Обратите внимание, что для всех этих примерах, если добавляемый сущность имеет ссылки на другие сущности, которые не отслеживаются затем еще эти новые сущности также будут добавляться к контексту и будет вставлен в базе данных при последующем вызове метода SaveChanges.  

## <a name="attaching-an-existing-entity-to-the-context"></a>Присоединение существующей сущности к контексту  

При наличии сущности, вы уже знаете, существует в базе данных, но которой не сейчас отслеживается контекстом можно указать контекст для отслеживания использует метод присоединения на DbSet сущности. Сущность будет в неизмененном состоянии, в контексте. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Blogs.Attach(existingBlog);

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание на то, что изменения не будут внесены в базу данных при вызове метода SaveChanges, не выполняя другие операции вложенные сущности. Это обусловлено сущность находится в неизмененном состоянии.  

Другой способ Присоединение существующей сущности к контексту — изменяет свое состояние на неизмененное. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Entry(existingBlog).State = EntityState.Unchanged;

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание, что для обоих этих примерах Если присоединяемый объект имеет ссылки на другие сущности, которые не отслеживаются затем эти новые сущности будет также присоединен к контексту в неизмененном состоянии.  

## <a name="attaching-an-existing-but-modified-entity-to-the-context"></a>Присоединение существующего но измененная сущность к контексту  

При наличии сущности, которые известны как уже существует в базе данных, но какие изменения внесены можно указать контекст, чтобы вложить сущность и задайте для его состояние Modified.
Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Entry(existingBlog).State = EntityState.Modified;

    // Do some more work...  

    context.SaveChanges();
}
```  

При изменении состояния для изменения все свойства сущности будут помечены как измененные и все значения свойств будут отправляться в базу данных при вызове метода SaveChanges.  

Обратите внимание, что если присоединяемый объект имеет ссылки на другие сущности, которые не отслеживаются, затем эти новые сущности будет присоединен к контексту в неизмененном состоянии, они не автоматически будут внесены изменения.
При наличии нескольких сущностей, которые должны быть помечены Modified необходимо задать состояние для каждого из этих сущностей по отдельности.  

## <a name="changing-the-state-of-a-tracked-entity"></a>Изменение состояния для отслеживаемой сущности  

Можно изменить состояние сущности, которая уже отслеживается, задав свойство состояния на соответствующую запись. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Blogs.Attach(existingBlog);
    context.Entry(existingBlog).State = EntityState.Unchanged;

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание на то, что обращаясь добавить или присоединить сущность, которая уже отслеживается может также использоваться для изменения состояния сущности. Например вызов присоединения для сущности, которая в настоящее время находится в добавленном состоянии изменит свое состояние на неизмененное.  

## <a name="insert-or-update-pattern"></a>Вставить или обновить шаблон  

Распространенный подход для некоторых приложений является либо добавить сущность в качестве нового (в результате чего вставки баз данных), или вложить сущность как существующих и пометить его как измененный (что обновления базы данных) в зависимости от значения первичного ключа.
Например при использовании сформированный базой данных целочисленных первичных ключей довольно часто рассматривать сущность с нуля ключ как новый и сущность с ключом ненулевое значение, как существующий.
Этот шаблон можно сделать путем установки состояние сущности на основе проверки значения первичного ключа. Пример:  

``` csharp
public void InsertOrUpdate(Blog blog)
{
    using (var context = new BloggingContext())
    {
        context.Entry(blog).State = blog.BlogId == 0 ?
                                   EntityState.Added :
                                   EntityState.Modified;

        context.SaveChanges();
    }
}
```  

Обратите внимание, что при изменении состояния для изменения все свойства сущности будут помечены как измененные, и все значения свойств будут отправляться в базу данных при вызове метода SaveChanges.  
